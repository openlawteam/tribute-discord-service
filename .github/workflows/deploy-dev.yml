name: GKE Development Deployment
on:
  push:
    branches:
      - main

env:
  DOCKER_REPO: openlaw/tribute-discord-service
  IMAGE_NAME: openlaw/tribute-discord-service
  # https://github.com/kubernetes-sigs/kustomize/releases
  KUSTOMIZE_VERSION: 'v4.4.0'
  GIT_COMMITTER_NAME: 'Pizza Dog'
  GIT_COMMITTER_EMAIL: 'dev@openlaw.io'
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true

jobs:
  deploy:
    name: Build and deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check available environment variables
        uses: actions/checkout@v2

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v2.x
      
      - name: Build Docker image and tag
        uses: docker/build-push-action@v1
        env:
          DOCKER_BUILDKIT: 1
        with:
          username: ${{ secrets.PUB_REPO_DOCKERHUB_USERNAME }}
          password: ${{ secrets.PUB_REPO_DOCKERHUB_ACCESS_TOKEN }}
          repository: ${{ env.DOCKER_REPO }}
          # Automatically tags the built image with the git short SHA prefixed with the branch name, e.g: master-xxxxxxx
          tags: ${{ env.GITHUB_REF_SLUG }}-${{ env.GITHUB_SHA_SHORT }}, dev
          # Only push on git master branch
          push: ${{ startsWith(github.ref, 'refs/heads/master') }}
          
      - name: Checkout openlawteam/lao-backends repo
        uses: actions/checkout@v2
        with: 
          repository: openlawteam/lao-backends
          token: ${{ secrets.PAT_OLBOT_REPO_RW }}

      - name: Download Kustomize
        uses: wei/curl@v1
        with:
            args: -sfLo kustomize.tar.gz https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${{ env.KUSTOMIZE_VERSION }}/kustomize_${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz 
      
      - name: Install Kustomize
        run: |
          tar -zxvf kustomize.tar.gz
          chmod +x kustomize
          ./kustomize version
      
      - name: Update and commit new dev image tag
        run: |
          ls
          cd dev
          ./../kustomize edit set image "${{ env.IMAGE_NAME }}:${{ env.GITHUB_REF_SLUG }}-${{ env.GITHUB_SHA_SHORT }}"
          git config --local user.email ${{ env.GIT_COMMITTER_EMAIL }}
          git config --local user.name ${{ env.GIT_COMMITTER_NAME }}
          git commit -am "auto-release(dev): ${{ env.IMAGE_NAME }}:${{ env.GITHUB_REF_SLUG }}-${{ env.GITHUB_SHA_SHORT }}"
          git show
      - name: Push changes to openlawteam/lao-backends
        uses: ad-m/github-push-action@master
        with:
          repository: openlawteam/lao-backends
          github_token: ${{ secrets.PAT_OLBOT_REPO_RW }}
